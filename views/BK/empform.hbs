<!DOCTYPE html>
<html lang="en">

<head>
    {{> header}}
</head>

<body>
    {{> navbar}}

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>Employee Form</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">Employee Form</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- Left column -->
                    <div class="col-md-12">
                        <!-- jQuery validation -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">Employee Details</h3>
                            </div>
                            <!-- /.card-header -->
                            <!-- Form start -->
                            <form id="employeeForm" action="/empdtsubmit" method="post" enctype="multipart/form-data">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="empCode">Employee Code</label>
                                        <input type="text" name="empCode" class="form-control" id="empCode" placeholder="" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="fname">First Name</label>
                                        <input type="text" name="fname" class="form-control" id="fname" placeholder="First Name">
                                    </div>
                                    <div class="form-group">
                                        <label for="lname">Last Name</label>
                                        <input type="text" name="lname" class="form-control" id="lname" placeholder="Last Name">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email address</label>
                                        <input type="email" name="email" class="form-control" id="email" placeholder="Enter email">
                                    </div>
                                    <div class="form-group">
                                        <label for="photo">Upload Photo</label>
                                        <input type="file" name="photo" class="form-control-file" id="photo">
                                        <button type="button" class="btn btn-primary d-flex mt-1" id="viewButton">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <h3 class="card-title">Personal Details</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="gender">Gender</label>
                                        <select class="form-control" id="employee_gender" name="employee_gender">
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="form-group col-3">
                                        <label for="dob">Date of Birth</label>
                                        <input type="date" name="dob" class="form-control" id="dob">
                                    </div>
                                    <div class="form-group col-3">
                                        <label for="doj">Date of Joining</label>
                                        <input type="date" name="doj" class="form-control" id="doj">
                                    </div>
                                    <div class="form-group">
                                        <label for="pre_address">Present Address</label>
                                        <textarea name="pre_address" class="form-control" id="pre_address" placeholder="Enter Present Address"></textarea>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" class="form-check-input" id="sameAddress" onclick="copyAddress()">
                                        <label class="form-check-label" for="sameAddress">Same as Permanent Address</label>
                                    </div>
                                    <div class="form-group">
                                        <label for="per_address">Permanent Address</label>
                                        <textarea name="per_address" class="form-control" id="per_address" placeholder="Enter Permanent Address"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="city_select">Select City</label>
                                        <select class="form-control select2bs4" id="city_select" name="city_select" style="width: 100%;">
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="state_select">Select State</label>
                                        <select class="form-control select2bs4" id="state_select" name="state_select" style="width: 100%;">
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="country_select">Select Country</label>
                                        <select class="form-control select2bs4" id="country_select" name="country_select" style="width: 100%;">
                                            <!-- Options will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="phone">Phone Number</label>
                                        <input type="text" class="form-control" id="phone" name="phone" placeholder="Enter Phone Number">
                                    </div>
                                    <div class="form-group">
                                        <label for="aadhar">Aadhar Number</label>
                                        <input type="text" class="form-control" id="aadhar" name="aadhar" placeholder="Enter Aadhar Number">
                                    </div>
                                </div>
                                <!-- Family Details Section -->
                                <div class="card-header">
                                    <h3 class="card-title">Family Details</h3>
                                </div>
                                <div class="card-body family-details-box">
                                    <!-- Family details section start -->
                                    <div id="familyDetailsContainer" class="border p-3 rounded">
                                        <!-- Top Row with Plus Icon -->
                                        <div class="row mb-2 align-items-center">
                                            <div class="col-12 d-flex justify-content-end">
                                                <i class="fas fa-plus plus-icon" id="addRowButton" style="cursor: pointer;"></i>
                                            </div>
                                        </div>
                                        
                                        <!-- Initial Row -->
                                        <div class="row family-detail-row align-items-end">
                                            <div class="col-3">
                                                <label for="famName_0">Name</label>
                                                <input type="text" id="famName_0" name="famName[]" class="form-control" placeholder="Enter Name">
                                            </div>
                                            <div class="col-3">
                                                <label for="famRelation_0">Relationship</label>
                                                <select name="famRelation[]" class="form-control" id="famRelation_0">
                                                    <option value="">Select Relationship</option>
                                                    <option value="Father">Father</option>
                                                    <option value="Mother">Mother</option>
                                                    <option value="Brother">Brother</option>
                                                    <option value="Sister">Sister</option>
                                                </select>
                                            </div>
                                            <div class="col-3">
                                                <label for="famAge_0">Age</label>
                                                <input type="number" id="famAge_0" name="famAge[]" class="form-control" placeholder="Enter Age">
                                            </div>
                                            <div class="col-3">
                                                <label for="famOccupation_0">Occupation</label>
                                                <input type="text" id="famOccupation_0" name="famOccupation[]" class="form-control" placeholder="Enter Occupation">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-2">
                                        <button type="button" class="btn btn-danger btn-custom" id="resetButton">Reset</button>
                                        <button type="button" class="btn btn-primary btn-custom ml-2" id="submitButton">Submit</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->

    <!-- Main Footer -->
    {{> footer}}

    <!-- jQuery -->
    <script src="../../plugins/jquery/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="../../plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
        $.widget.bridge('uibutton', $.ui.button);
    </script>
    <!-- Bootstrap 4 -->
    <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../../dist/js/adminlte.js"></script>
    <!-- Select2 -->
    <script src="../../plugins/select2/js/select2.full.min.js"></script>
    <!-- InputMask -->
    <script src="../../plugins/moment/moment.min.js"></script>
    <script src="../../plugins/inputmask/jquery.inputmask.min.js"></script>

    <script>
        $(document).ready(function() {
            // Fetch the next employee code
            $.get('/next-empcode', function(data) {
                let nextEmpCode = data.nextEmpCode.toString();
                $('#empCode').val(nextEmpCode.padStart(6, '0'));
            }).fail(function() {
                console.error('Failed to fetch the next employee code.');
            });

            // Populate dropdowns with data from APIs
            function populateSelect(url, selectId) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">Select</option>';
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => console.error(`Error fetching data from ${url}:`, error));
            }

            populateSelect('/gender-select', 'employee_gender');
            populateSelect('/city-select', 'city_select');
            populateSelect('/state-select', 'state_select');
            populateSelect('/country-select', 'country_select');
        });

        // Initialize Select2 Elements
        $(function() {
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
        });

        // Checkbox for copying address
        function copyAddress() {
            const presentAddress = document.getElementById('pre_address').value;
            const permanentAddress = document.getElementById('per_address');
            const sameAddressCheckbox = document.getElementById('sameAddress');

            permanentAddress.value = sameAddressCheckbox.checked ? presentAddress : '';
        }

        // Photo view script
        document.getElementById('viewButton').addEventListener('click', function() {
            const fileInput = document.getElementById('photo');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    const w = window.open('');
                    w.document.write(img.outerHTML);
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please upload a file first.');
            }
        });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('familyDetailsContainer');
        let rowCount = 1; // Start with the first row

        document.getElementById('addRowButton').addEventListener('click', function() {
            // Clone the first row
            const newRow = container.querySelector('.family-detail-row').cloneNode(true);

            // Update the IDs and names for the new row
            newRow.querySelectorAll('input, select').forEach(input => {
                // Update IDs
                const newId = input.id.split('_')[0] + '_' + rowCount;
                input.id = newId;

                // Update names
                input.name = input.name.replace(/\[\d+\]/, `[${rowCount}]`);
            });

            // Clear the values of the new row
            newRow.querySelectorAll('input, select').forEach(input => {
                input.value = '';
            });

            // Append the new row to the container
            container.appendChild(newRow);

            // Update rowCount for the next row
            rowCount++;
        });

        // Handle the Reset button
        document.getElementById('resetButton').addEventListener('click', function() {
            // Remove all rows except the first one
            const rows = container.querySelectorAll('.family-detail-row');
            rows.forEach((row, index) => {
                if (index > 0) container.removeChild(row);
            });
            rowCount = 1; // Reset the rowCount
        });

        // Handle the Submit button
        document.getElementById('submitButton').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('employeeForm'));

            // Add family details to FormData
            const familyDetails = Array.from(container.querySelectorAll('.family-detail-row')).map(row => {
                const famName = row.querySelector('[name="famName[]"]').value;
                const famRelation = row.querySelector('[name="famRelation[]"]').value;
                const famAge = row.querySelector('[name="famAge[]"]').value;
                const famOccupation = row.querySelector('[name="famOccupation[]"]').value;

                return { famName, famRelation, famAge, famOccupation };
            }).filter(detail => detail.famName || detail.famRelation || detail.famAge || detail.famOccupation);

            // Append family details as JSON
            formData.append('familyDetails', JSON.stringify(familyDetails));

            fetch('/empdtsubmit', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(result => {
                alert(result);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
</script>


</body>
</html>
